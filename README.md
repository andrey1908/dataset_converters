# dataset_scripts
Репозиторий содержит скрипты, написанные на python3, для работы с файлаим разметки (в основном в формате COCO) и изображениями.
\
\
\
**converters/coco2darknet.py**\
Конвертирует разметку из формата COCO в формат, используемый при обучении в darknet.
```bash
Параметры:
-json, --json-file                      - путь к файлу с разметкой
-img-root-fld, --images-root-folder     - путь к папке с изображениями из разметки
-out-list, --out-list-file              - путь к выходному файлу со списком путей к изображениям
-out-anns-fld, --out-annotations-folder - путь к папке, куда будут сохраненны файлы с конвертированной разметкой
-root-fld, --root-folder [default './'] - путь к папке, относительно которой будут задаваться пути к изображенияим, которые записываются в файл, указанный в параметре -out-list
```
\
\
**coco_nms.py**\
Реализует алгоритм NMS.
```bash
Параметры:
-json, --json-file - путь к файлу с разметкой
-thr, --threshold  - порог IoU для алгоритма NMS
-out, --out-file   - путь к выходному файлу
```
Для работы скрипта необходимо скомпилировать код nms.c в динамическую библиотеку nms.so
```bash
gcc nms.c -shared -fPIC -o nms.so
```
\
\
**dataset_info.py**\
Выводит некоторую информацию о датасете.
```bash
Параметры:
-json, --json-file - пути к файлу с разметкой
```
\
\
**draw_boxes.py**\
Отрисовывает боксы из разметки на изображениях.
```bash
Параметры:
-json, --json-file                                     - путь к файлу с разметкой
-img-fld, --images-folder                              - путь к папке с изображениями
-out-fld, --out-folder                                 - путь к папке, куда будут сохраняться изображения с отрисованными на них боксами
-imgs-to-draw, --images-files-to-draw [optional]       - пути к изображениям (относительно текущей директории), на которых нужно отрисовать боксы
-num, --images-number [optional]                       - количество изображений, на которых нужно отрисовать боксы. Не имеет эффекта, если используется флаг -imgs-to-draw
-rnd, --random [optional]                              - если указан параметр -num, то для отрисовки будут выбраны случайные изображения, иначе первые
-owb, --only-with-boxes [optional]                     - если указан параметр -num, то для отрисовки не будут выбираться изображения без боксов
-img-json, --images-json-file [optional]               - если в качестве параметра -json указан файл с детекциями (без изображений и категорий), то в этом параметре нужно
                                                         указать путь к файлу с изображениями и категориями
-preserve-files-tree, --preserve-files-tree [optional] - при сохранении отрисованных изображений будет сохраняться файловая структура изображений в исходном датасете,
                                                         иначе все изображения будут сохряняться в одну папку, а изображения с одинаковыми именами будут переименовываться.
-thr, --threshold [default 0.]                         - если в аннотации есть поле score, то она будет отброшенна, если значение этого поля меньше значения данного параметра
```
Если не указан ни один из флагов **-imgs-to-draw** и **-num**, то будут отрисовываться все изображения в датасете.\
\
\
**mark_coco_annotations.py**\
Добавляет поле с указанным значением к аннотациям.
```bash
Параметры:
-json, --json-file - путь к файлу с разметкой
-f, --field        - название поля, которое нужно добавить
-v, --value        - значение добавляемого поля. К данному аргументу применяется метод eval()
--force [optional] - перезаписывать данные, если поле уже существует. Если не указывать данный флаг, то при обнаружении, что добавляемое поле уже существует,
                     программа будет прерванна.
-out, --out-file   - путь к выходному файлу
```
\
\
**metrics_eval.py**\
Вычисляет метрики mAP и AP.
```bash
Параметры:
-ann, --annotations-file            - путь к файлу с аннотациями
-det, --detections-file             - путь к файлу с детекциями
-area, --area [default 0**2 1e5**2] - при вычислении метрик из детекций и аннотаций будут удалены боксы, площадь которых находится вне диапазона, указанного
                                      в данном параметре (см. также параметр -shape). В качестве верхнего предела можно указать -1, что будет эквивалентно 1e5**2
-shape, --shape [default None None] - если используется значение по умолчанию (None None), то площадь боксов берется на исходном изображении. Если передать два числа,
                                      то перед отбасыванием неподходящих по размеру боксов, изображение будет отмаштабированно с сохранением соотношения сторон так,
                                      чтобы влазить в рамки с шириной и высотой, взятыми из параметра -shape. Площади боксов будут пересчитаны соответствующим образом.
```
\
\
**remove_empty_images.py**\
Удаляет из файла с разметкой изображения, для которых нет ни одной аннотации.
```bash
Параметры:
-json, --json-file - путь к файлу с разметкой
-out, --out-file   - путь к выходному файлу
```
\
\
**replace_classes.py**\
Объединяет, удаляет, добавляет, переименовывает категории в файле с разметкой.
```bash
Параметры (см. пример использования ниже):
-json, --json-file                               - путь к файлу с разметкой
-new-cats, --new-categories-names                - названия новых категорий, на которые будут заменены старые
-old-cat-name-to-new, --old-category-name-to-new - преобразование старых категорий в новые. Одно преобразование задается в формате old_category_name->new_category_name.
                                                   Разные преобразования разделяются пробелом. Данный параметр принимает один арнумант, а не список аргументов,
                                                   то есть все преобразования должны быть взяты в кавычки. Название категории new_category_name должно присутствовать в списке,
                                                   передаваемом через парамерт -new-cats (см. пример ниже)
                                                   В качестве аргумента также можно указать convert_all_categories (или conv_all_cats). В этом случае параметр -new-cats принимает
                                                   только один аргумент и происходит конвертация всех категорий в разметке в одну категорию, переданную в параметре -new-cats
-out, --out-file                                 - путь к выходному файлу
```
Например, если есть разметка с категорями **person**, **car** и **van**, и нужно преобразовать **person** в **pedestrian**, а **car** и **van** в **vehicle**, то используется следующая команда
```bash
python replace_classes.py
    -json annotations.json
    -new-cats pedestrian vehicle
    -old-cat-name-to-new 'person->pedestrian car->vehicle van->vehicle'
    -out new_annotations.json
```
\
\
**split_coco.py**\
Разбивает файл с разметкой на два. Перед разбиением изображения перемешиваются.
```bash
Параметры:
-json, --json-file              - путь к файлу с разметкой
-train, --train-out-file        - путь к первому выходному файлу
-test, --test-out-file          - путь ко второму выходному файлу
-sr, --split-rate [default 0.8] - доля изображений в файле, который был передан в параметре -train
```
\
\
**unite_coco.py**\
Объединяет несколько файлов с разметкой в один. Категории с одинаковыми названиями объединяются в одну. Изображения с одинаковым полем file_name объединяются в одно изображение.
```bash
Параметры:
-jsons, --json-files - пути к файлам с разметкой
-out, --out-file     - путь к выходному файлу
```
\
\
**unite_datasets.py**\
Объединяет несколько файлов с разметкой в один и копирует изображения из получившейся разметки в отдельную папку. Категории с одинаковыми названиями объединяются в одну.
Если встречаются изображения с одинаковыми именами (именно именами, а не полем file_name), то одно из них переименовывается, чтобы не было изображений с одинаковыми именами.
```bash
Параметры:
-jsons, --json-files              - пути к файлам с разметкой
-img-flds, --images-folders       - пути к папкам с изображениями из разметок, указанных в параметре -jsons
-out, --out-file                  - путь к выходному файлу с разметкой
-out-img-fld, --out-images-folder - путь к папке, куда будут помещаться изображения из получившейся разметки
-ml, --make-links [optional]      - делать жесткие ссылки на изображения, а не копировать их
-co, --copy-ok [optional]         - если не получилось создать жесткую ссылку, то не прерывать работу программы, а просто скопировать изображение
```
